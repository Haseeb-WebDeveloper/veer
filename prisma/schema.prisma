generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
}

// ============================================
// USERS & AUTHENTICATION
// ============================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  profile          Profile?
  businessSettings BusinessSettings?
  integrations    Integration[]
  calls            Call[]
  appointments     Appointment[]
  forms            Form[]
  formSubmissions  FormSubmission[]
  formAttachments  FormAttachment[]
  automationJobs   AutomationJob[]
  aiPrompts        AIPrompt[]
  notifications    Notification[]
  subscription     Subscription?
  emailUsage       EmailUsage[]
  submissionNotes  SubmissionNote[]

  @@map("users")
}

model Profile {
  id           String   @id @default(uuid())
  userId       String   @unique @map("user_id")
  businessName String   @map("business_name")
  logoUrl      String?  @map("logo_url")
  industry     String? // 'hvac', 'plumbing', 'dental', 'legal', 'salon', etc.
  phone        String?
  email        String?
  country      String   @default("US")
  timezone     String   @default("America/New_York")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

// ============================================
// INTEGRATIONS
// ============================================

model Integration {
  id     String @id @default(uuid())
  userId String @map("user_id")
  type   IntegrationType
  status IntegrationStatus @default(INACTIVE)

  // Provider (for email: GMAIL, OUTLOOK, CUSTOM; for calendar: GOOGLE; for Twilio: TWILIO)
  provider String // Required - EmailProvider for EMAIL type, 'GOOGLE' for CALENDAR, 'TWILIO' for TWILIO

  // Common fields
  connectedAt   DateTime? @map("connected_at")
  lastSyncAt    DateTime? @map("last_sync_at")
  errorMessage  String?   @map("error_message") @db.Text

  // Email-specific fields (when type = EMAIL)
  emailAddress          String?  @map("email_address")
  emailOauthToken       String?  @map("email_oauth_token") // ENCRYPTED
  emailOauthRefreshToken String? @map("email_oauth_refresh_token") // ENCRYPTED
  emailOauthTokenExpiresAt DateTime? @map("email_oauth_token_expires_at")
  
  // SMTP fields (when type = EMAIL and provider = CUSTOM)
  smtpHost     String? @map("smtp_host")
  smtpPort     Int?    @map("smtp_port")
  smtpUser     String? @map("smtp_user")
  smtpPassword String? @map("smtp_password") // ENCRYPTED
  smtpFromEmail String? @map("smtp_from_email") // The actual "From" email address for sent emails

  // Calendar-specific fields (when type = CALENDAR)
  googleCalendarId      String?  @map("google_calendar_id")
  calendarAccessToken   String?  @map("calendar_access_token") // ENCRYPTED
  calendarRefreshToken  String?  @map("calendar_refresh_token") // ENCRYPTED
  calendarTokenExpiresAt DateTime? @map("calendar_token_expires_at")

  // Twilio-specific fields (when type = TWILIO)
  twilioAccountSid   String?  @map("twilio_account_sid")
  twilioAuthToken    String?  @map("twilio_auth_token") // ENCRYPTED
  twilioPhoneNumber  String?  @map("twilio_phone_number")

  // Provider-specific config (JSON for flexibility)
  config Json? @default("{}")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type, provider]) // Allow multiple providers per type (e.g., Gmail + Custom SMTP)
  @@index([userId])
  @@index([userId, type])
  @@index([userId, type, status]) // For finding active integrations
  @@index([status])
  @@map("integrations")
}

// ============================================
// BUSINESS SETTINGS
// ============================================

model BusinessSettings {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")

  // Phone settings
  forwardToNumber   String? @map("forward_to_number")

  // AI Voice settings
  voiceId          String  @default("default") @map("voice_id")
  voiceLanguage    String  @default("en-US") @map("voice_language")
  greetingMessage  String  @default("Thank you for calling. How can I help you today?") @map("greeting_message")
  afterHoursMessage String @default("We are currently closed. Please leave your information and we will call you back.") @map("after_hours_message")

  // Business hours (stored as JSON)
  businessHours Json @default("{\"monday\": {\"open\": \"09:00\", \"close\": \"17:00\"}, \"tuesday\": {\"open\": \"09:00\", \"close\": \"17:00\"}, \"wednesday\": {\"open\": \"09:00\", \"close\": \"17:00\"}, \"thursday\": {\"open\": \"09:00\", \"close\": \"17:00\"}, \"friday\": {\"open\": \"09:00\", \"close\": \"17:00\"}, \"saturday\": {\"open\": \"10:00\", \"close\": \"14:00\"}, \"sunday\": {\"closed\": true}}") @map("business_hours")

  // Notifications
  smsNotifications   Boolean @default(true) @map("sms_notifications")
  emailNotifications Boolean @default(true) @map("email_notifications")
  notificationPhone  String? @map("notification_phone")
  notificationEmail  String? @map("notification_email")

  // Automation defaults
  defaultAutomationEmailTemplate String? @map("default_automation_email_template") @db.Text
  defaultAutomationSmsTemplate   String? @map("default_automation_sms_template")
  autoFollowUpEnabled             Boolean @default(true) @map("auto_follow_up_enabled")
  followUpDelayHours              Int     @default(24) @map("follow_up_delay_hours")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("business_settings")
}

// ============================================
// VOICE AGENT - CALLS
// ============================================

model Call {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  twilioCallSid String   @unique @map("twilio_call_sid")
  fromNumber    String   @map("from_number")
  toNumber      String   @map("to_number")

  // Status
  status    CallStatus @default(IN_PROGRESS)
  direction String     @default("inbound") // 'inbound', 'outbound'

  // Timing
  startedAt       DateTime  @default(now()) @map("started_at")
  endedAt         DateTime? @map("ended_at")
  durationSeconds Int       @default(0) @map("duration_seconds")

  // Content
  transcript Json    @default("[]") // [{role: 'user', text: '...'}, {role: 'assistant', text: '...'}]
  summary    String? // AI-generated summary
  callType   String? @map("call_type") // 'appointment', 'quote', 'emergency', 'information', 'other'

  // Lead capture
  customerName    String? @map("customer_name")
  customerPhone   String? @map("customer_phone")
  customerEmail   String? @map("customer_email")
  customerAddress String? @map("customer_address")
  serviceRequested String? @map("service_requested")
  urgency         Urgency @default(NORMAL)
  notes           String?

  // Recording
  recordingUrl      String? @map("recording_url")
  recordingDuration Int?    @map("recording_duration")

  // Appointment
  appointmentId String? @map("appointment_id")

  // Metrics
  sentiment     String?  @map("sentiment") // 'positive', 'neutral', 'negative'
  wasTransferred Boolean @default(false) @map("was_transferred")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointment  Appointment?  @relation(fields: [appointmentId], references: [id])
  notifications Notification[]

  @@index([userId])
  @@index([createdAt])
  @@index([status])
  @@index([customerPhone])
  @@map("calls")
}

enum CallStatus {
  IN_PROGRESS
  COMPLETED
  FAILED
  NO_ANSWER
  BUSY
  CANCELLED
}

enum Urgency {
  EMERGENCY
  URGENT
  NORMAL
  LOW
}

// ============================================
// APPOINTMENTS
// ============================================

model Appointment {
  id       String  @id @default(uuid())
  userId   String  @map("user_id")
  callId   String? @map("call_id")
  formSubmissionId String? @map("form_submission_id")

  // Customer details
  customerName    String  @map("customer_name")
  customerPhone   String  @map("customer_phone")
  customerEmail   String? @map("customer_email")
  customerAddress String? @map("customer_address")

  serviceType String? @map("service_type")

  // Timing
  scheduledAt     DateTime @map("scheduled_at")
  durationMinutes Int      @default(60) @map("duration_minutes")

  // Status
  status AppointmentStatus @default(SCHEDULED)

  // Notes
  notes         String? // Customer-facing notes
  internalNotes String? @map("internal_notes") // Staff notes

  // Google Calendar
  googleEventId String? @map("google_event_id")

  // Reminders
  reminderSent   Boolean   @default(false) @map("reminder_sent")
  reminderSentAt DateTime? @map("reminder_sent_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  calls          Call[]
  formSubmission FormSubmission? @relation(fields: [formSubmissionId], references: [id])

  @@index([userId])
  @@index([scheduledAt])
  @@index([status])
  @@index([customerPhone])
  @@map("appointments")
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
  RESCHEDULED
}

// ============================================
// AI PROMPTS (Industry-specific scripts)
// ============================================

model AIPrompt {
  id       String @id @default(uuid())
  userId   String @map("user_id")
  name     String // 'Main Greeting', 'After Hours', 'Emergency Handler'
  promptType String @map("prompt_type") // 'system', 'greeting', 'emergency', 'booking'
  promptText String @map("prompt_text") @db.Text

  // Settings
  isActive      Boolean @default(true) @map("is_active")
  orderPriority Int     @default(0) @map("order_priority")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("ai_prompts")
}

// ============================================
// FORMS & SUBMISSIONS
// ============================================

model Form {
  id          String  @id @default(uuid())
  userId      String  @map("user_id")
  name        String // Internal name
  title       String? // Display title
  description String?

  // Fields configuration (array of field objects)
  fields Json // [{ type, name, label, required, placeholder, options }]

  // Styling
  theme Json @default("{\"primaryColor\": \"#3B82F6\", \"submitText\": \"Submit\"}") // { primaryColor, submitText, etc. }

  // Settings
  isActive       Boolean @default(true) @map("is_active")
  redirectUrl    String? @map("redirect_url")
  successMessage String  @default("Thank you! We will be in touch soon.") @map("success_message")
  
  // Form builder settings (step 3)
  formSettings   Json?   @default("{}") @map("form_settings") // { redirectBehavior, successMessage, etc. }
  
  // Automation configuration (step 4)
  automationConfig Json? @default("{}") @map("automation_config") // Store automation setup from builder

  // File upload settings
  allowFileUploads Boolean @default(false) @map("allow_file_uploads")
  maxFileSize      Int?    @default(5242880) @map("max_file_size") // 5MB in bytes
  allowedFileTypes String[] @default([]) @map("allowed_file_types") // ['image/jpeg', 'application/pdf']

  // Embed code (auto-generated)
  embedCode String? @unique @map("embed_code")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  submissions      FormSubmission[]
  automations      FormAutomation[]

  @@index([userId])
  @@index([embedCode]) // For public form lookups
  @@map("forms")
}

model FormSubmission {
  id     String @id @default(uuid())
  formId String @map("form_id")
  userId String @map("user_id")

  // Submitted data
  data Json // { name: "John", email: "...", phone: "...", ... }

  // Metadata
  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")
  referrer  String?
  source    FormSubmissionSource? @map("source")

  // Status
  status SubmissionStatus @default(NEW)

  // Lead scoring & tracking
  leadScore    Int      @default(0) @map("lead_score")
  contactedAt  DateTime? @map("contacted_at")
  convertedAt  DateTime? @map("converted_at")

  // Tags
  tags String[] @default([])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  form              Form              @relation(fields: [formId], references: [id], onDelete: Cascade)
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  attachments       FormAttachment[]
  automationLogs    AutomationLog[]
  automationJobs    AutomationJob[]
  appointments      Appointment[]
  submissionNotes   SubmissionNote[]

  @@index([formId])
  @@index([userId])
  @@index([createdAt])
  @@index([status])
  @@index([userId, status]) // Composite for dashboard queries
  @@index([userId, createdAt]) // Composite for recent submissions
  @@map("form_submissions")
}

enum SubmissionStatus {
  NEW
  CONTACTED
  QUALIFIED
  CONVERTED
  LOST
  SPAM
}

// ============================================
// FORM ATTACHMENTS
// ============================================

model FormAttachment {
  id           String   @id @default(uuid())
  submissionId String   @map("submission_id")
  userId       String   @map("user_id")
  
  // Cloudinary details
  cloudinaryPublicId String   @map("cloudinary_public_id")
  cloudinaryUrl      String   @map("cloudinary_url")
  cloudinarySecureUrl String  @map("cloudinary_secure_url")
  
  // File metadata
  fileName     String   @map("file_name")
  fileType     String   @map("file_type") // MIME type
  fileSize     Int      @map("file_size") // bytes
  fieldName    String?  @map("field_name") // Which form field uploaded this
  
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  submission FormSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([submissionId])
  @@index([userId])
  @@map("form_attachments")
}

// ============================================
// FORM AUTOMATIONS
// ============================================

model FormAutomation {
  id     String @id @default(uuid())
  formId String @map("form_id")
  name   String? // User-friendly name

  // Trigger
  triggerEvent AutomationTrigger @default(ON_SUBMIT) @map("trigger_event")
  triggerCondition Json? @map("trigger_condition") // { field: 'status', operator: 'equals', value: 'NEW' }

  // Settings
  isActive     Boolean @default(true) @map("is_active")
  stopOnError Boolean @default(false) @map("stop_on_error") // Stop if one action fails
  runOnce      Boolean @default(false) @map("run_once") // Only run once per submission

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  form    Form            @relation(fields: [formId], references: [id], onDelete: Cascade)
  actions AutomationAction[]

  @@index([formId])
  @@index([formId, isActive]) // Composite for active automations
  @@map("form_automations")
}

// ============================================
// AUTOMATION ACTIONS
// ============================================

model AutomationAction {
  id           String @id @default(uuid())
  automationId String @map("automation_id")
  
  // Action details
  type         AutomationActionType
  order        Int     @default(0) // Execution order
  
  // Configuration (type-specific)
  config       Json    // { recipient, subject, message, template, etc. }
  
  // Delay settings
  delayType    DelayType @default(NONE) @map("delay_type")
  delayValue   Int?    @default(0) @map("delay_value")
  delayCondition Json? @map("delay_condition") // { field: 'status', operator: 'not_equals', value: 'CONTACTED' }
  
  // Conditional execution
  conditions   Json?   @default("[]") // [{ field, operator, value }]
  
  // Settings
  isActive     Boolean @default(true) @map("is_active")
  retryOnFailure Boolean @default(false) @map("retry_on_failure")
  maxRetries   Int     @default(0) @map("max_retries")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  automation FormAutomation @relation(fields: [automationId], references: [id], onDelete: Cascade)
  jobs       AutomationJob[]

  @@index([automationId])
  @@index([automationId, order]) // Composite for ordered execution
  @@map("automation_actions")
}

enum AutomationActionType {
  EMAIL_CUSTOMER
  EMAIL_OWNER
  SMS_CUSTOMER
  SMS_OWNER
  WEBHOOK
  SCHEDULE_FOLLOWUP
  UPDATE_STATUS
  ADD_TAG
  CREATE_APPOINTMENT
}

// ============================================
// AUTOMATION JOBS (Queue System)
// ============================================

model AutomationJob {
  id           String   @id @default(uuid())
  submissionId String   @map("submission_id")
  actionId     String   @map("action_id")
  userId       String   @map("user_id")
  
  // Job status
  status       JobStatus @default(PENDING)
  priority     Int       @default(0) // Higher = execute first
  
  // Scheduling
  scheduledFor DateTime  @map("scheduled_for") // When to execute
  executedAt   DateTime? @map("executed_at")
  
  // Execution tracking
  attemptCount Int       @default(0) @map("attempt_count")
  maxAttempts  Int       @default(3) @map("max_attempts")
  errorMessage String?   @map("error_message") @db.Text
  
  // Result data
  result       Json?     // Response from action execution
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  submission FormSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  action     AutomationAction @relation(fields: [actionId], references: [id], onDelete: Cascade)
  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs       AutomationLog[]

  @@index([status, scheduledFor]) // For job queue queries
  @@index([submissionId])
  @@index([actionId])
  @@index([userId, status, scheduledFor]) // Composite for efficient queue processing
  @@index([status, priority, scheduledFor]) // Composite for efficient queue processing
  @@map("automation_jobs")
}

enum JobStatus {
  PENDING
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  RETRYING
}

// ============================================
// AUTOMATION LOGS
// ============================================

model AutomationLog {
  id           String   @id @default(uuid())
  submissionId String   @map("submission_id")
  jobId        String?  @map("job_id")
  actionId     String?  @map("action_id")
  
  actionType   String   @map("action_type")
  status       LogStatus
  
  // Execution details
  errorMessage String?  @map("error_message") @db.Text
  executionTime Int?    @map("execution_time") // milliseconds
  metadata     Json?    @default("{}")
  
  executedAt   DateTime @default(now()) @map("executed_at")

  // Relations
  submission FormSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  job        AutomationJob? @relation(fields: [jobId], references: [id], onDelete: SetNull)

  @@index([submissionId])
  @@index([actionId])
  @@index([executedAt])
  @@index([status, executedAt]) // For analytics
  @@map("automation_logs")
}

enum LogStatus {
  SUCCESS
  FAILED
  PENDING
  SKIPPED
}

// ============================================
// INTEGRATION ENUMS
// ============================================

enum EmailProvider {
  GMAIL
  OUTLOOK
  CUSTOM
}

enum FormSubmissionSource {
  WEBSITE
  EMBED
  API
  IMPORT
}

enum AutomationTrigger {
  ON_SUBMIT
  ON_STATUS_CHANGE
  ON_TAG_ADDED
  ON_FIELD_CHANGE
  SCHEDULED
}

enum DelayType {
  NONE
  SECONDS
  MINUTES
  HOURS
  DAYS
  CONDITION
}

enum IntegrationType {
  EMAIL
  CALENDAR
  TWILIO
}

enum IntegrationStatus {
  ACTIVE
  INACTIVE
  ERROR
  EXPIRED
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id     String  @id @default(uuid())
  userId String  @map("user_id")
  callId String? @map("call_id")

  // Notification details
  type      NotificationType
  recipient String
  subject   String?
  message   String            @db.Text
  status    NotificationStatus @default(PENDING)

  // Timing
  sentAt   DateTime? @map("sent_at")
  errorMessage String? @map("error_message")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  call Call? @relation(fields: [callId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@index([status])
  @@map("notifications")
}

enum NotificationType {
  SMS
  EMAIL
  PUSH
  WEBHOOK
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  DELIVERED
  BOUNCED
}
  
// ============================================
// SUBSCRIPTION & BILLING
// ============================================

model Subscription {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")

  // Stripe details
  stripeCustomerId     String? @unique @map("stripe_customer_id")
  stripeSubscriptionId String? @unique @map("stripe_subscription_id")

  // Plan details
  planType     PlanType @default(STARTER) @map("plan_type")
  priceAmount  Int? // in cents
  currency     String   @default("usd")

  // Status
  status              SubscriptionStatus @default(ACTIVE)
  trialEndsAt         DateTime?          @map("trial_ends_at")
  currentPeriodStart  DateTime?          @map("current_period_start")
  currentPeriodEnd    DateTime?          @map("current_period_end")
  cancelAt            DateTime?          @map("cancel_at")
  canceledAt          DateTime?          @map("canceled_at")

  // Usage tracking
  callsThisPeriod Int @default(0) @map("calls_this_period")
  callsLimit      Int @default(500) @map("calls_limit")
  formsThisPeriod Int @default(0) @map("forms_this_period")
  formsLimit      Int @default(100) @map("forms_limit")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

enum PlanType {
  STARTER   // $197/mo - Voice or Forms
  PROFESSIONAL // $347/mo - Voice + Forms + Calendar
  ENTERPRISE   // $597/mo - Everything + Custom
  TRIAL
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
  INCOMPLETE
  INCOMPLETE_EXPIRED
  TRIALING
  UNPAID
}

// ============================================
// EMAIL USAGE TRACKING
// ============================================

model EmailUsage {
  id     String   @id @default(uuid())
  userId String   @map("user_id")
  date   DateTime @db.Date
  count  Int      @default(0)

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date]) // One record per user per date
  @@index([userId])
  @@index([date])
  @@map("email_usage")
}

// ============================================
// SUBMISSION NOTES
// ============================================

model SubmissionNote {
  id           String   @id @default(uuid())
  submissionId String   @map("submission_id")
  userId       String   @map("user_id")
  
  note         String   @db.Text
  isInternal   Boolean  @default(false) @map("is_internal") // Internal vs customer-facing
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  submission FormSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  user       User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([submissionId])
  @@index([userId])
  @@map("submission_notes")
}
